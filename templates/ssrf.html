<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>SSRF Challenge - OGP Preview</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">Vulnerable App</a>
        </div>
    </nav>
    <div class="container mt-5">
        <h1 class="mb-4">OGPプレビュー生成</h1>
        <p>URLを貼り付けると、OGP情報（タイトル、説明、画像）を読み込んでプレビューを表示します。</p>
        
        <div class="alert alert-info">
            <strong>まずは正しい使い方を試してみよう！</strong><br>
            <a href="/sample" target="_blank" rel="noopener noreferrer">こちらのサンプルページ</a>のURL (<code>http://127.0.0.1:5000/sample</code>) をコピーして、下のフォームに入力してみてください。
        </div>
        <form id="ogp-form">
            <div class="input-group mb-3">
                <input type="text" class="form-control" name="url" id="url-input" placeholder="https://example.com" required>
                <button class="btn btn-primary" type="submit">プレビュー生成</button>
            </div>
        </form>

        <h2 class="mt-5">プレビュー結果</h2>
        <div id="loading" style="display: none;">
            <p>読み込み中...</p>
        </div>
        <div id="result-area">
            <!-- 結果はここに表示される -->
        </div>
        
        <div class="mt-4">
            <h3>チャレンジ目標</h3>
            <p>この機能を利用して、内部ネットワークに存在する <code>http://internal_api:5000/internal</code> の情報を取得してください。</p>
        </div>
    </div>

    <script>
        const form = document.getElementById('ogp-form');
        const urlInput = document.getElementById('url-input');
        const resultArea = document.getElementById('result-area');
        const loading = document.getElementById('loading');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const url = urlInput.value;

            // 結果表示エリアをリセット
            resultArea.innerHTML = '';
            loading.style.display = 'block';

            try {
                // バックエンドにリクエスト
                const response = await fetch(`/fetch?url=${encodeURIComponent(url)}`);
                
                // レスポンスのContent-Typeを確認
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    // JSONの場合 (成功時)
                    const data = await response.json();
                    
                    let card = '<div class="card" style="max-width: 540px;">'; // カード全体の最大幅を設定
                    let cardContent = '<div class="row g-0">';

                    // 画像のURLを解決
                    const imageUrl = data.image ? new URL(data.image, data.original_url || url).href : null;

                    if (imageUrl) {
                        cardContent += '<div class="col-md-4">';
                        cardContent += `<img src="${imageUrl}" class="img-fluid rounded-start" alt="OGP Image" style="object-fit: cover; height: 100%;">
`;
                        cardContent += '</div>';
                        cardContent += '<div class="col-md-8">';
                    } else {
                        cardContent += '<div class="col-md-12">';
                    }

                    cardContent += '<div class="card-body d-flex flex-column h-100">'; // flexboxで高さを揃える

                    if (data.title) {
                        cardContent += `<h5 class="card-title">${data.title}</h5>`;
                    }
                    if (data.description) {
                        cardContent += `<p class="card-text text-muted small flex-grow-1">${data.description}</p>`;
                    }
                    // URLをハイパーリンクにする
                    cardContent += `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-decoration-none text-secondary mt-auto"><small>${new URL(url).hostname}</small></a>`;

                    cardContent += '</div></div>'; // card-body, col の閉じタグ
                    cardContent += '</div>'; // row の閉じタグ
                    
                    resultArea.innerHTML = card + cardContent + '</div>';

                } else {
                    // JSON以外の場合 (攻撃成功時やエラー時)
                    const textData = await response.text();
                    resultArea.innerHTML = `
                        <div class="alert alert-warning">
                            <h4 class="alert-heading">プレビュー生成失敗</h4>
                            <p>OGP情報が見つからなかったか、URLが不正です。</p>
                            <hr>
                            <p class="mb-0">サーバーからの応答:</p>
                            <pre><code>${textData.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</code></pre>
                        </div>`;
                }

            } catch (error) {
                resultArea.innerHTML = `<div class="alert alert-danger">エラーが発生しました: ${error}</div>`;
            } finally {
                loading.style.display = 'none';
            }
        });
    </script>
</body>
</html>